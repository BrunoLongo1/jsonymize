#!/usr/bin/env node
var jsonymize = require("../lib/jsonymize");
var fs = require("fs");
var cjson = require("cjson");
var yargs = require("yargs")
    .usage("Anonymize JSON values.\n\nUsage: jsonymize [fields]")
    .options("i", {
      alias: "ignore",
      description: "JSON field to ignore (can be repeated multiple times)"
    })
    .options("c", {
      alias: "config",
      description: "Advanced configuration file"
    })
    .options("h", {
      alias: "help",
      description: "Show this help message"
    });

var argv = yargs.argv;

if (argv.help) {
  yargs.showHelp();
  return;
}

if (argv.config && !fs.existsSync(argv.config)) {
  console.error("Configuration file \"" + argv.config + "\" could not be read.");
  return;
}

var config = argv.config ? cjson.load(argv.config) : {};
var fields = argv._ || config.fields || [];
var ignore = argv.ignore || config.ignore || [];
var generators = config.generators;

process.stdin.resume();
process.stdin.setEncoding("utf8");

var lines = [];
process.stdin.on("data", function(line) {
  lines.push(line);
});

process.stdin.on("end", function () {
  var json = JSON.parse(lines.join());

  var anonymized = jsonymize(json, {
    fields: (fields.length ? fields : undefined),
    ignore: (ignore.length ? ignore : undefined),
    generators: generators
  });

  process.stdout.write(anonymized + "\n");
});
